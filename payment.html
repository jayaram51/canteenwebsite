<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Payment - Smart Canteen</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #141E30, #243B55);
    min-height: 100vh;
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
  }

  header {
    text-align: center;
    margin-bottom: 25px;
  }
  header h1 {
    font-size: clamp(2rem, 6vw, 3rem);
    font-weight: 700;
    color: #fff;
  }
  header p {
    margin-top: 5px;
    font-weight: 500;
    color: #fff;
  }

  .card {
    background: rgba(255,255,255,0.08);
    border-radius: 20px;
    backdrop-filter: blur(12px);
    padding: 25px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.4);
    max-width: 400px;
    width: 100%;
    text-align: center;
  }

  .card h2 {
    color: #fff;
    margin-bottom: 15px;
    text-shadow: 0 0 6px #00e5ff;
  }

  .order-details, #queueNumber {
    margin: 15px 0;
    font-weight: 600;
    color: #fff;
    text-shadow: 0 0 4px #00e5ff;
  }

  #totalAmount {
    font-size: 1.2rem;
    margin-bottom: 15px;
  }

  #paymentImage {
    margin-top: 20px;
    max-width: 200px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,198,255,0.5);
  }

  footer {
    text-align: center;
    padding: 15px;
    margin-top: 30px;
    color: #a4b0be;
  }
</style>
</head>
<body>

<header>
  <h1>üç¥ Smart Canteen Payment</h1>
  <p>Scan QR and pay to confirm your order</p>
</header>

<div class="card">
  <h2>Order Details</h2>
  <div class="order-details" id="orderDetails">Loading order...</div>
  <div id="totalAmount">Total: ‚Çπ0</div>
  <div id="queueNumber">Queue Number: Loading...</div>
  <img id="paymentImage" src="qr.jpg" alt="Payment QR">
  <p>Scan the above QR or follow instructions to pay.</p>
</div>

<footer>
  <p>¬© 2025 Smart Canteen | Built for College Project</p>
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
  import { getDatabase, ref, push, set, onValue, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCeLj-v5Coav6llAeDP30bKn4-k-OzpcQM",
    authDomain: "loginpage-536d9.firebaseapp.com",
    projectId: "loginpage-536d9",
    storageBucket: "loginpage-536d9.appspot.com",
    messagingSenderId: "445956902411",
    appId: "1:445956902411:web:b4d31d65a212f3fc46c10e",
    databaseURL:"https://loginpage-536d9-default-rtdb.firebaseio.com/"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const prices = {
    "Veg-noodles": 50,
    "Chicken-noodles": 70,
    "Veg-fried-rice": 60,
    "Chicken-fried-rice": 75
  };

  // Get food and qty from URL
  const params = new URLSearchParams(window.location.search);
  const food = params.get('food');
  const qty = parseInt(params.get('qty'));

  if (!food || !qty || isNaN(qty) || !prices[food]) {
    document.getElementById('orderDetails').innerText = "Invalid order!";
    document.getElementById('totalAmount').innerText = "Total: ‚Çπ0";
    document.getElementById('queueNumber').innerText = "Queue Number: N/A";
    alert("Invalid order! Provide ?food=FoodName&qty=Number in URL.");
  } else {
    const total = prices[food] * qty;
    document.getElementById('orderDetails').innerText = `${food.replace(/-/g," ")} x ${qty}`;
    document.getElementById('totalAmount').innerText = `Total: ‚Çπ${total}`;

    const order = {
      food: food.replace(/-/g," "),
      qty: qty,
      total: total,
      completed: false
    };

    // Save order in "orders" temporarily
    push(ref(db, 'orders'), order)
      .then(() => console.log("Order pushed!"))
      .catch(err => console.error(err));

    // Get latest queue number from "finalOrders"
    // Get queue number from finalOrders
const finalRef = query(ref(db, "finalOrders"), limitToLast(1));
onValue(finalRef, (snapshot) => {
  let queueNum = 1;
  if (snapshot.exists()) {
    snapshot.forEach(child => {
      const lastOrder = child.val();
      queueNum = lastOrder.queue ? lastOrder.queue + 1 : 1;
    });
  }
  document.getElementById('queueNumber').innerText = `Queue Number: ${queueNum}`;

  // Save queue number to localStorage so it doesn't change on reload
  localStorage.setItem("currentQueueNumber", queueNum);

  // Only assign this queue number once, do NOT push to finalOrders yet
  order.queue = queueNum;
});

  }
</script>

</body>
</html>
